name: Job Fetcher Service
on:
  workflow_dispatch:
    inputs:
      country:
        description: 'Country for job search'
        required: true
        default: 'Worldwide'
        type: string
      keyword:
        description: 'Keyword for job search (optional)'
        required: false
        default: ''
        type: string
      wp_site_url:
        description: 'WordPress Site URL'
        required: true
        type: string
      wp_username:
        description: 'WordPress Username'
        required: true
        type: string
      wp_app_password:
        description: 'WordPress Application Password'
        required: true
        type: string
      license_key:
        description: 'License Key for Full Data Access'
        required: false
        default: ''
        type: string
      linkedin_cookies:
        description: 'LinkedIn Cookies JSON for authenticated scraping'
        required: false
        default: ''
        type: string

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml urllib3 selenium
        
    - name: Install Google Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip fontconfig libfontconfig1 libjpeg8 libpng16-16 libx11-6 libxext6 libxrender1 xfonts-75dpi xfonts-base
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb
        sudo apt-get -f install -y
        
    - name: Install ChromeDriver
      run: |
        # Get the full Chrome version (e.g., 141.0.7390.107)
        CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f 3)
        CHROME_MAJOR=$(echo $CHROME_VERSION | cut -d '.' -f 1)
        echo "Detected Chrome version: $CHROME_VERSION (major: $CHROME_MAJOR)"
        
        # Fetch the latest ChromeDriver version for the major version from chrome-for-testing
        LATEST_JSON=$(curl -sS https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json)
        CHROMEDRIVER_VERSION=$(echo $LATEST_JSON | grep -o "\"version\":\"[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\"" | grep "\"$CHROME_MAJOR\." | head -1 | cut -d '"' -f 4)
        
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          echo "No exact match found for Chrome $CHROME_MAJOR; falling back to latest stable (114.0.5735.90)"
          CHROMEDRIVER_VERSION="114.0.5735.90"
        fi
        
        echo "Using ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        # Download and install ChromeDriver (fallback to legacy URL if needed)
        DOWNLOAD_URL="https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-${CHROMEDRIVER_VERSION}.zip"
        if [ "$CHROMEDRIVER_VERSION" = "114.0.5735.90" ]; then
          DOWNLOAD_URL="https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        fi
        
        wget -N "$DOWNLOAD_URL" -P /tmp/
        unzip /tmp/*.zip -d /tmp/
        sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version
        
    - name: Create uploads directory
      run: mkdir -p uploads
      
    - name: Run Job Fetcher
      env:
        WP_SITE_URL: ${{ github.event.inputs.wp_site_url }}
        WP_USERNAME: ${{ github.event.inputs.wp_username }}
        WP_APP_PASSWORD: ${{ github.event.inputs.wp_app_password }}
        COUNTRY: ${{ github.event.inputs.country }}
        KEYWORD: ${{ github.event.inputs.keyword }}
        LICENSE_KEY: ${{ github.event.inputs.license_key }}
        LINKEDIN_COOKIES: ${{ github.event.inputs.linkedin_cookies }}
      run: |
        echo "Starting job fetcher with authentication..."
        echo "Country: ${{ github.event.inputs.country }}"
        echo "Keyword: '${{ github.event.inputs.keyword }}'"
        echo "Site URL: ${{ github.event.inputs.wp_site_url }}"
        echo "License key: ${LICENSE_KEY:0:8}..."
        echo "LinkedIn cookies: ${LINKEDIN_COOKIES:0:50}..."
        python fetcher.py
        
    - name: Upload logs and results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fetcher-logs-and-results
        path: |
          uploads/fetcher.log
          uploads/*.json
          uploads/processed_job_ids.json
          uploads/last_processed_page.txt
        retention-days: 7
        compression-level: 6
