name: Job Fetcher Service
on:
  workflow_dispatch:
    inputs:
      country:
        description: 'Country for job search'
        required: true
        default: 'Worldwide'
        type: string
      keyword:
        description: 'Keyword for job search (optional)'
        required: false
        default: ''
        type: string
      wp_site_url:
        description: 'WordPress Site URL'
        required: true
        type: string
      wp_username:
        description: 'WordPress Username'
        required: true
        type: string
      wp_app_password:
        description: 'WordPress Application Password'
        required: true
        type: string
      license_key:
        description: 'License Key for Full Data Access'
        required: false
        default: ''
        type: string
      linkedin_cookies:
        description: 'LinkedIn Cookies JSON for authenticated scraping'
        required: false
        default: ''
        type: string

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml urllib3 selenium

    - name: Install Google Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip fontconfig libfontconfig1 libjpeg8 libpng16-16 libx11-6 libxext6 libxrender1 xfonts-75dpi xfonts-base
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y

    - name: Install ChromeDriver from local ZIP
      run: |
        set -e
        echo "Installing ChromeDriver from uploaded ZIP file..."
        if [ -f "./chromedriver-linux64.zip" ]; then
          ZIPFILE="./chromedriver-linux64.zip"
        elif [ -f "./chromedriver.zip" ]; then
          ZIPFILE="./chromedriver.zip"
        else
          echo "❌ ChromeDriver ZIP not found in repository root!"
          exit 1
        fi

        unzip -o "$ZIPFILE" -d /tmp/
        if [ -d "/tmp/chromedriver-linux64" ]; then
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
        elif [ -f "/tmp/chromedriver" ]; then
          sudo mv /tmp/chromedriver /usr/local/bin/
        else
          echo "❌ ChromeDriver binary not found in ZIP"
          exit 1
        fi
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version

    - name: Create uploads directory
      run: mkdir -p uploads

    - name: Run Job Fetcher
      env:
        WP_SITE_URL: ${{ github.event.inputs.wp_site_url }}
        WP_USERNAME: ${{ github.event.inputs.wp_username }}
        WP_APP_PASSWORD: ${{ github.event.inputs.wp_app_password }}
        COUNTRY: ${{ github.event.inputs.country }}
        KEYWORD: ${{ github.event.inputs.keyword }}
        LICENSE_KEY: ${{ github.event.inputs.license_key }}
        LINKEDIN_COOKIES: ${{ github.event.inputs.linkedin_cookies }}
      run: |
        echo "Starting job fetcher..."
        echo "Country: $COUNTRY"
        echo "Keyword: $KEYWORD"
        echo "Site: $WP_SITE_URL"
        echo "License: ${LICENSE_KEY:0:8}..."
        python fetcher.py

    - name: Upload logs and results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fetcher-logs-and-results
        path: |
          uploads/fetcher.log
          uploads/*.json
          uploads/processed_job_ids.json
          uploads/last_processed_page.txt
        retention-days: 7
        compression-level: 6
